
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier de Classe</title>
    <style>
        /* --- Styles G√©n√©raux --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            color: #000000;
            height: 100vh;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Conteneur Principal du Calendrier --- */
        #calendar-container {
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* --- En-t√™te (Mois, Ann√©e, Navigation) --- */
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            flex-shrink: 0; /* Emp√™che l'en-t√™te de se r√©duire */
        }

        .header-group {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .header-group:first-child {
            justify-content: flex-start;
        }
        .header-group:last-child {
            justify-content: flex-end;
        }
        #month-nav {
            justify-content: center;
        }
        #month-year {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin: 0 15px;
        }

        .nav-btn, #counting-btn, #export-btn, #import-btn {
            background-color: #ffffff;
            border: 2px solid #000000;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 15px;
            user-select: none; /* Emp√™che la s√©lection du texte */
            transition: background-color 0.2s, color 0.2s;
            margin-left: 5px;
        }
        
        .nav-btn {
             font-size: 2rem;
        }

        .nav-btn:hover, #counting-btn:hover, #export-btn:hover, #import-btn:hover {
            background-color: #000000;
            color: #ffffff;
        }
        
        #counting-btn.active {
            background-color: #000;
            color: #fff;
        }

        /* --- Structure de la Grille --- */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto repeat(6, 1fr); /* 1 ligne pour les en-t√™tes, 6 pour les jours */
            gap: 5px;
            flex-grow: 1; /* Prend l'espace vertical restant */
            min-height: 0;
        }
        
        /* --- Style des Cellules --- */
        .grid-cell {
            border: 1px solid #000000;
            position: relative;
            padding: 5px;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
            font-size: 1.2rem;
            border: 2px solid #000;
            align-items: center;
            justify-content: center;
        }

        .day-number {
            font-size: 1.5rem;
            position: absolute;
            top: 3px;
            left: 5px;
        }
        
        .day-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .day-cell:hover {
            background-color: #f0f0f0;
        }
        
        .empty-cell {
            background-color: #f8f8f8;
            cursor: default;
            border-color: #ccc;
        }

        /* --- Marqueurs Sp√©ciaux --- */
        .today {
            border: 3px solid #000000;
            font-weight: bold;
        }
        
        .counting-highlight {
            background-color: #000000;
            color: #ffffff;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 2px;
            width: 1.5em;
            height: 1.5em;
        }
        
        .wrong-click {
            animation: shake 0.4s;
        }

        @keyframes shake {
          10%, 90% { transform: translateX(-1px); }
          20%, 80% { transform: translateX(2px); }
          30%, 50%, 70% { transform: translateX(-4px); }
          40%, 60% { transform: translateX(4px); }
        }

        .day-content-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            width: 100%;
            height: 100%;
        }

        /* --- Image et Ic√¥nes dans une cellule --- */
        .event-image {
            max-width: 60%;
            max-height: 60%;
            object-fit: contain;
        }
        
        .weekend-icon {
            position: absolute;
            bottom: 5px;
            right: 5px; /* MODIFI√â: D√©plac√© √† droite pour √©viter la superposition */
            font-size: 1.5rem;
        }

        .user-house-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5rem;
        }

        /* --- Modal pour les actions --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none; /* Cach√© par d√©faut */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border: 2px solid #000;
            text-align: center;
        }

        .modal-content h3 {
            margin-top: 0;
            font-size: 1.8rem;
        }

        .modal-content p {
            font-size: 1.1rem;
        }

        .modal-content button {
            display: inline-block;
            width: auto;
            padding: 12px 20px;
            margin: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            background-color: #fff;
            border: 2px solid #000;
            transition: background-color 0.2s, color 0.2s;
        }

        #modal-confirm-import {
             background-color: #000;
             color: #fff;
        }

        .modal-content button:hover {
            background-color: #333;
            color: #fff;
        }
        #modal-cancel-import:hover {
            background-color: #ddd;
            color: #000;
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 768px) { /* Pour tablettes */
            #calendar-container {
                padding: 15px;
            }
            #month-year {
                font-size: 2rem;
            }
            .day-number {
                font-size: 1.2rem;
            }
            .nav-btn, #counting-btn, #export-btn, #import-btn {
                font-size: 1rem;
                padding: 4px 10px;
            }
            .nav-btn {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) { /* Pour t√©l√©phones mobiles */
            #calendar-container {
                padding: 10px;
                border: none;
                box-shadow: none;
            }
            #calendar-header {
                flex-direction: column;
                gap: 10px; /* Espace entre les lignes */
                margin-bottom: 10px;
            }
            #month-year {
                font-size: 1.8rem;
                margin: 0 10px;
            }
            .grid-cell {
                padding: 2px;
                font-size: 0.8rem;
            }
            .day-header {
                font-size: 0.9rem;
                padding: 5px 0;
            }
            .day-number {
                font-size: 1rem;
            }
            .weekend-icon, .user-house-icon {
                font-size: 1rem;
            }
        }

    </style>
</head>
<body>
    <input type="file" id="import-file-input" accept=".json" style="display: none;">
    <div id="calendar-container">
        <div id="calendar-header">
            <div class="header-group">
                <button id="counting-btn">Compter</button>
                <button id="export-btn">Exporter</button>
                <button id="import-btn">Importer</button>
            </div>
            <div class="header-group" id="month-nav">
                <button class="nav-btn" id="prev-month">&lt;</button>
                <h2 id="month-year"></h2>
                <button class="nav-btn" id="next-month">&gt;</button>
            </div>
            <div class="header-group"></div> <!-- Placeholder for balance -->
        </div>
        <div id="calendar-grid">
            <!-- Le contenu du calendrier sera g√©n√©r√© par JavaScript ici -->
        </div>
    </div>

    <!-- Fen√™tre modale pour les actions sur une case -->
    <div id="action-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Modifier le jour</h3>
            <button id="modal-add-image">Ajouter/Modifier Image</button>
            <button id="modal-toggle-house">Ajouter/Enlever Maison</button>
            <button id="modal-cancel">Annuler</button>
        </div>
    </div>
    
    <!-- Fen√™tre modale pour la confirmation d'importation -->
    <div id="import-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmer l'importation</h3>
            <p>√ätes-vous s√ªr? Cela √©crasera toutes les donn√©es actuelles du calendrier.</p>
            <button id="modal-confirm-import">Oui, importer</button>
            <button id="modal-cancel-import">Annuler</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- √âl√©ments du DOM ---
            const monthYearDisplay = document.getElementById('month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const countingBtn = document.getElementById('counting-btn');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            // --- √âl√©ments du DOM pour les Modals ---
            const actionModal = document.getElementById('action-modal');
            const modalAddImageBtn = document.getElementById('modal-add-image');
            const modalToggleHouseBtn = document.getElementById('modal-toggle-house');
            const modalCancelBtn = document.getElementById('modal-cancel');
            
            const importConfirmModal = document.getElementById('import-confirm-modal');
            const modalConfirmImportBtn = document.getElementById('modal-confirm-import');
            const modalCancelImportBtn = document.getElementById('modal-cancel-import');

            // --- √âtat du Calendrier ---
            let currentDate = new Date();
            let selectedCell = null; 
            let isCountingMode = false;
            let countHighlight = 1;
            let calendarData = {};
            let fileToImport = null;

            // --- Constantes ---
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            const dayNames = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
            const LOCAL_STORAGE_KEY = 'calendarTSAData';

            // --- Fonctions de Sauvegarde/Chargement ---
            function saveData() {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(calendarData));
            }

            function loadData() {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                calendarData = data ? JSON.parse(data) : {};
            }
            
            // --- Fonctions des Modals ---
            function openActionModal(cell) {
                selectedCell = cell;
                actionModal.style.display = 'flex';
            }

            function closeActionModal() {
                selectedCell = null;
                actionModal.style.display = 'none';
            }
            
            function openImportConfirmModal(file) {
                 fileToImport = file;
                 importConfirmModal.style.display = 'flex';
            }
            
            function closeImportConfirmModal() {
                 fileToImport = null;
                 importConfirmModal.style.display = 'none';
            }
            
            // --- Fonctions d'action ---
            function handleImageAction() {
                if (!selectedCell) return;
                const dateKey = selectedCell.dataset.date;
                const currentImageUrl = calendarData[dateKey]?.imageUrl || '';
                const imageUrl = prompt("Veuillez entrer l'URL de l'image :", currentImageUrl);

                if (!calendarData[dateKey]) calendarData[dateKey] = {};

                if (imageUrl) {
                    calendarData[dateKey].imageUrl = imageUrl;
                } else {
                    delete calendarData[dateKey].imageUrl;
                }
                saveData();
                renderCalendar(); 
                closeActionModal();
            }

            function toggleUserHouse() {
                if (!selectedCell) return;
                const dateKey = selectedCell.dataset.date;
                if (!calendarData[dateKey]) calendarData[dateKey] = {};
                
                calendarData[dateKey].hasHouse = !calendarData[dateKey].hasHouse;
                
                saveData();
                renderCalendar();
                closeActionModal();
            }
            
            // --- Fonctions de comptage ---
            function handleCountingClick(day, dayCell) {
                if (day === countHighlight) {
                    const dayNumberElement = dayCell.querySelector('.day-number');
                    dayNumberElement.classList.add('counting-highlight');
                    countHighlight++;
                } else if (day > 0) {
                    dayCell.classList.add('wrong-click');
                    setTimeout(() => { dayCell.classList.remove('wrong-click'); }, 400);
                }
            }

            function clearCountingHighlights() {
                document.querySelectorAll('.counting-highlight').forEach(num => num.classList.remove('counting-highlight'));
            }

            function resetCountingMode() {
                isCountingMode = false;
                countingBtn.textContent = 'Compter';
                countingBtn.classList.remove('active');
                clearCountingHighlights();
                countHighlight = 1;
            }

            // --- Fonction Principale pour Afficher le Calendrier ---
            function renderCalendar() {
                calendarGrid.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

                // 1. Ajouter les en-t√™tes des jours de la semaine √† la grille
                dayNames.forEach(day => {
                    const dayHeaderCell = document.createElement('div');
                    dayHeaderCell.classList.add('day-header');
                    dayHeaderCell.textContent = day;
                    calendarGrid.appendChild(dayHeaderCell);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();

                // 2. Remplir la grille avec 42 cases (jours + vides)
                for (let i = 0; i < 42; i++) {
                    const dayCell = document.createElement('div');
                    const day = i - firstDayOfMonth + 1;

                    if (day > 0 && day <= daysInMonth) {
                        // C'est un jour valide du mois
                        dayCell.classList.add('grid-cell', 'day-cell');
                        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        dayCell.dataset.date = dateKey;
                        
                        const dayNumber = document.createElement('span');
                        dayNumber.classList.add('day-number');
                        dayNumber.textContent = day;
                        dayCell.appendChild(dayNumber);

                        const contentWrapper = document.createElement('div');
                        contentWrapper.classList.add('day-content-wrapper');
                        dayCell.appendChild(contentWrapper);
                        
                        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                            dayCell.classList.add('today');
                        }
                        
                        const dayOfWeek = new Date(year, month, day).getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            const houseIcon = document.createElement('span');
                            houseIcon.textContent = 'üè†';
                            houseIcon.classList.add('weekend-icon');
                            dayCell.appendChild(houseIcon);
                        }
                        
                        // Appliquer les donn√©es sauvegard√©es
                        if (calendarData[dateKey]) {
                            if (calendarData[dateKey].imageUrl) {
                                const img = document.createElement('img');
                                img.src = calendarData[dateKey].imageUrl;
                                img.classList.add('event-image');
                                img.onerror = () => img.src = 'https://placehold.co/100x100/000000/FFFFFF?text=Erreur';
                                contentWrapper.appendChild(img);
                            }
                            if (calendarData[dateKey].hasHouse) {
                                const houseIcon = document.createElement('span');
                                houseIcon.textContent = 'üè†';
                                houseIcon.classList.add('user-house-icon');
                                dayCell.appendChild(houseIcon);
                            }
                        }
                        
                        dayCell.dataset.clickCount = '0';
                        dayCell.addEventListener('click', () => {
                            if (isCountingMode) {
                                handleCountingClick(day, dayCell);
                            } else {
                                if (dayCell.clickResetTimer) clearTimeout(dayCell.clickResetTimer);
                                let count = parseInt(dayCell.dataset.clickCount, 10) + 1;
                                if (count >= 5) {
                                    dayCell.dataset.clickCount = '0';
                                    openActionModal(dayCell);
                                } else {
                                    dayCell.dataset.clickCount = count;
                                    dayCell.clickResetTimer = setTimeout(() => { dayCell.dataset.clickCount = '0'; }, 1500);
                                }
                            }
                        });
                    } else {
                        // C'est une case vide
                        dayCell.classList.add('grid-cell', 'empty-cell');
                    }
                    calendarGrid.appendChild(dayCell);
                }
            }

            // --- Gestionnaire de clics multiples ---
            function multiClickHandler(element, callback) {
                element.dataset.clickCount = '0';
                 element.addEventListener('click', () => {
                    if (element.clickResetTimer) clearTimeout(element.clickResetTimer);
                    let count = parseInt(element.dataset.clickCount, 10) + 1;
                    if (count >= 5) {
                        element.dataset.clickCount = '0';
                        callback();
                    } else {
                        element.dataset.clickCount = count;
                        element.clickResetTimer = setTimeout(() => { element.dataset.clickCount = '0'; }, 1500);
                    }
                 });
            }

            // --- Gestionnaires d'√âv√©nements ---
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); resetCountingMode(); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); resetCountingMode(); renderCalendar(); });
            
            countingBtn.addEventListener('click', () => {
                isCountingMode = !isCountingMode;
                if (isCountingMode) {
                    countHighlight = 1;
                    clearCountingHighlights();
                    countingBtn.textContent = 'Arr√™ter de Compter';
                    countingBtn.classList.add('active');
                } else {
                    resetCountingMode();
                }
            });

            multiClickHandler(exportBtn, () => {
                const dataStr = JSON.stringify(calendarData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'sauvegarde_calendrier.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
            
            multiClickHandler(importBtn, () => {
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    openImportConfirmModal(file);
                }
                // R√©initialise l'input pour permettre de r√©importer le m√™me fichier
                importFileInput.value = '';
            });

            // Gestionnaires pour le modal d'action
            modalAddImageBtn.addEventListener('click', handleImageAction);
            modalToggleHouseBtn.addEventListener('click', toggleUserHouse);
            modalCancelBtn.addEventListener('click', closeActionModal);
            
            // Gestionnaires pour le modal d'importation
            modalConfirmImportBtn.addEventListener('click', () => {
                if (!fileToImport) return;
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const importedData = JSON.parse(e.target.result);
                         calendarData = importedData;
                         saveData();
                         renderCalendar();
                     } catch (error) {
                        console.error("Erreur lors de l'analyse du fichier JSON:", error);
                        alert("Le fichier de sauvegarde est invalide ou corrompu.");
                     } finally {
                        closeImportConfirmModal();
                     }
                 };
                 reader.readAsText(fileToImport);
            });
            modalCancelImportBtn.addEventListener('click', closeImportConfirmModal);

            // Initialisation
            loadData();
            renderCalendar();
        });
    </script>
</body>
</html>

